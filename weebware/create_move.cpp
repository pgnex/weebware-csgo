#include "Header.h"
#include "shared.h"
#include "create_move.h"
#include "Legit.h"
#include "hook_funcs.h"

c_create_move g_create_move;

bool hook_functions::clientmode_cm(float input_sample_time, c_usercmd* cmd)
{
	Vector original_angles = cmd->viewangles;

	if (cmd->command_number == 0)
	{
		return g_hooking.o_createmove(g_weebware.g_client_mode, input_sample_time, cmd);
	}

	if (cmd && cmd->command_number)
	{
		if (g_weebware.g_engine->is_connected() && g_weebware.g_engine->is_in_game())
		{
			g_create_move.local = g_weebware.g_entlist->getcliententity(g_weebware.g_engine->get_local());

			if (g_create_move.local->is_valid_player())
			{
				try
				{
					g_create_move.local->m_pActiveWeapon()->Update_Accuracy_Penalty();

					g_create_move.create_move(cmd);

#pragma region Legit
					g_legitbot.m_local = g_create_move.local;

					g_legitbot.create_move(cmd);

					g_accuracy.accuracy_boost(cmd);
#pragma endregion

					g_ai.create_move(cmd, g_create_move.local);

#pragma region Clamping
				}
				catch (...)
				{
					printf("Exception Caught in Createmove\n");
				}


				QAngle cmd_view = cmd->viewangles;

				g_maths.normalize_angle(cmd_view);

				g_maths.clamp_angle(cmd_view);

				cmd->viewangles = cmd_view;

				g_create_move.correct_movement(original_angles, cmd);

				g_maths.normalize_angle(cmd->viewangles);

				g_maths.clamp_angle(cmd->viewangles);

				// clamping movement.

				if (cmd->forwardmove > 450)
					cmd->forwardmove = 450;

				if (cmd->forwardmove < -450)
					cmd->forwardmove = -450;

				if (cmd->sidemove > 450)
					cmd->sidemove = 450;

				if (cmd->sidemove < -450)
					cmd->sidemove = -450;

#pragma endregion
			}
			else
			{
				try {
					g_accuracy.clear_all_records();
				}
				catch (...) {}

				g_Walkbot.m_target_area = nullptr;
			}
		}
	}
	return false;
}

void c_create_move::correct_movement(Vector old_view_angles, c_usercmd* cmd)
{
	Vector o_move(cmd->forwardmove, cmd->sidemove, cmd->upmove);
	float speed = o_move.size(), yaw;
	QAngle wish_dir;
	g_maths.vector_qangles3d(o_move, wish_dir);
	yaw = DEG2RAD(cmd->viewangles.y - old_view_angles.y + wish_dir.y);
	cmd->forwardmove = cos(yaw) * speed;
	cmd->sidemove = sin(yaw) * speed;
	if (cmd->viewangles.x < -90.f || cmd->viewangles.x > 90.f)
		cmd->forwardmove = -cmd->forwardmove;
}

void c_create_move::create_move(c_usercmd* cmd)
{
	if (!g_weebwarecfg.enable_misc)
	{
		return;
	}

	auto_jump(cmd);
}

void c_create_move::auto_jump(c_usercmd* cmd)
{
	if (!g_weebwarecfg.auto_jump)
	{
		return;
	}

	// If Local is in air.
	if (!(this->local->m_fFlags() & fl_onground))
	{
		// release jump flag.
		cmd->buttons &= ~in_jump;
	}
}

// I don't really want this autistic shit in here.
#if 0
void reconnect()
{
	static auto fn = reinterpret_cast<unsigned int(__stdcall*)(int, int)>(g_entry.pattern_scan("client.dll", "A1 ? ? ? ? D1 E8 A8 01 74 29"));
	fn(0, 0);
}

char** printisongoingmatchlol()
{
	//55 8B EC A1 ? ? ? ? 8B 4D 08  client // we dont know much about the params. heres the parent function

	static auto fn = reinterpret_cast<char**(*)()>(g_entry.pattern_scan("client.dll", "55 8B EC A1 ? ? ? ? 83 EC 10 A8 01 0F 85 ? ? ? ? C7 45 ? ? ? ? ? 83 C8 01 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? A3 ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 10 45 F0 C7 05 ? ? ? ? ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ? C7 05 ? ? ? ? ? ? ? ? 0F 10 45 F0 C7 45 ? ? ? ? ? C7 45 ? ? ? ? ? 0F 11 05 ? ? ? ?"));
	return fn();
}
#endif

